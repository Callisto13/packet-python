matrix:
  PYTHON_VERSION:
    - 2.7
    - 3.4
    - 3.5
    - 3.6
    - 3.7

pipeline:
  fmt_and_lint:
    image: python:3.6-alpine
    commands:
      - pip install pylama yapf
      - yapf -dr packet | (! grep '.')
      - pylama packet test setup.py

  test:
    image: python:${PYTHON_VERSION}
    commands:
      - pip install tox
      - tox -e py$(echo ${PYTHON_VERSION} | sed 's|\.||')

  build_sdist:
    image: python
    commands:
      - python setup.py sdist bdist_wheel

  upload_test_pypi:
    image: python
    environment:
      TWINE_REPOSITORY: testpypi
      TWINE_REPOSITORY_URL: https://test.pypi.org/legacy/
    commands:
      - env | sort | grep DRONE
      - pip install twine
      - twine upload dist/*
    when:
      event: tag
    secrets: [twine_username, twine_password]

  upload_pypi:
    image: python
    commands:
      - env | sort | grep DRONE
      - pip install twine
      - twine upload dist/*
    when:
      event: tag
    secrets: [twine_username, twine_password]
